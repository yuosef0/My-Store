-- ============================================
-- ๐ง ุฅุตูุงุญ ุณูุงุณุงุช RLS ูุฌุฏูู top_bar_messages
-- ============================================
-- ูุฐุง ุงูููู ูุญู ูุดููุฉ: "new row violates row-level security policy"
-- ุนูุฏ ูุญุงููุฉ ุฅุถุงูุฉ ุฃู ุชุนุฏูู ุฑุณุงุฆู ุงูุดุฑูุท ุงูุฃุญูุฑ
-- ============================================

-- 1๏ธโฃ ุงูุชุฃูุฏ ูู ูุฌูุฏ ุฏุงูุฉ is_admin
-- ============================================
CREATE OR REPLACE FUNCTION is_admin(user_id UUID)
RETURNS BOOLEAN AS $$
BEGIN
  RETURN EXISTS (
    SELECT 1 FROM admins
    WHERE admins.user_id = $1
    AND is_active = true
  );
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 2๏ธโฃ ุญุฐู ุงูุณูุงุณุงุช ุงููุฏููุฉ
-- ============================================
DROP POLICY IF EXISTS "ุงูุฌููุน ูููููู ุฑุคูุฉ ุงูุฑุณุงุฆู ุงููุดุทุฉ" ON top_bar_messages;
DROP POLICY IF EXISTS "ุงูุฃุฏูู ูููููู ุฅุฏุงุฑุฉ ุงูุฑุณุงุฆู" ON top_bar_messages;
DROP POLICY IF EXISTS "ุงูุฃุฏูู ูููููู ูุฑุงุกุฉ ุฌููุน ุงูุฑุณุงุฆู" ON top_bar_messages;
DROP POLICY IF EXISTS "ุงูุฃุฏูู ูููููู ุฅุถุงูุฉ ุฑุณุงุฆู" ON top_bar_messages;
DROP POLICY IF EXISTS "ุงูุฃุฏูู ูููููู ุชุนุฏูู ุฑุณุงุฆู" ON top_bar_messages;
DROP POLICY IF EXISTS "ุงูุฃุฏูู ูููููู ุญุฐู ุฑุณุงุฆู" ON top_bar_messages;

-- 3๏ธโฃ ุฅูุดุงุก ุณูุงุณุงุช ุฌุฏูุฏุฉ ูุงุถุญุฉ
-- ============================================

-- ุณูุงุณุฉ ุงููุฑุงุกุฉ: ุงูุฌููุน ูููููู ุฑุคูุฉ ุงูุฑุณุงุฆู ุงููุดุทุฉุ ูุงูุฃุฏูู ูููููู ุฑุคูุฉ ูู ุดูุก
CREATE POLICY "ุงูุฌููุน ูููููู ุฑุคูุฉ ุงูุฑุณุงุฆู ุงููุดุทุฉ" ON top_bar_messages
  FOR SELECT USING (
    is_active = true OR is_admin(auth.uid())
  );

-- ุณูุงุณุฉ ุงูุฅุถุงูุฉ: ููุท ุงูุฃุฏูู ูููููู ุฅุถุงูุฉ ุฑุณุงุฆู ุฌุฏูุฏุฉ
CREATE POLICY "ุงูุฃุฏูู ูููููู ุฅุถุงูุฉ ุฑุณุงุฆู" ON top_bar_messages
  FOR INSERT WITH CHECK (
    is_admin(auth.uid())
  );

-- ุณูุงุณุฉ ุงูุชุนุฏูู: ููุท ุงูุฃุฏูู ูููููู ุชุนุฏูู ุงูุฑุณุงุฆู
CREATE POLICY "ุงูุฃุฏูู ูููููู ุชุนุฏูู ุฑุณุงุฆู" ON top_bar_messages
  FOR UPDATE USING (
    is_admin(auth.uid())
  );

-- ุณูุงุณุฉ ุงูุญุฐู: ููุท ุงูุฃุฏูู ูููููู ุญุฐู ุงูุฑุณุงุฆู
CREATE POLICY "ุงูุฃุฏูู ูููููู ุญุฐู ุฑุณุงุฆู" ON top_bar_messages
  FOR DELETE USING (
    is_admin(auth.uid())
  );

-- 4๏ธโฃ ุงูุชุฃูุฏ ูู ุชูุนูู RLS
-- ============================================
ALTER TABLE top_bar_messages ENABLE ROW LEVEL SECURITY;

-- 5๏ธโฃ ุฅุนุงุฏุฉ ุชุญููู schema cache
-- ============================================
NOTIFY pgrst, 'reload schema';

-- ============================================
-- โ ุงูุชูู ุงูุฅุตูุงุญ!
-- ============================================
-- ุงูุขู ูููู ููุฃุฏูู ุฅุถุงูุฉ ูุชุนุฏูู ูุญุฐู ุฑุณุงุฆู ุงูุดุฑูุท ุงูุฃุญูุฑ
--
-- โ๏ธ ููุงุญุธุฉ ูููุฉ:
-- ุชุฃูุฏ ูู ุฃู ุงููุณุชุฎุฏู ุงูุฐู ุชุณุชุฎุฏูู ูุณุฌู ูู ุฌุฏูู admins
-- ูุฃู is_active = true
--
-- ููุชุญูู ูู ุงูุฃุฏูู ุงูุญุงูููู:
-- SELECT * FROM admins WHERE is_active = true;
--
-- ูุฅุถุงูุฉ ูุณุชุฎุฏู ูุฃุฏูู:
-- INSERT INTO admins (user_id, email, full_name, role, is_active)
-- VALUES ('USER_UUID_HERE', 'user@example.com', 'ุงุณู ุงููุณุชุฎุฏู', 'admin', true);
-- ============================================
